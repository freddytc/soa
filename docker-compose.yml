version: '3.8'

# ═══════════════════════════════════════════════════════════════════════════
# Docker Compose - Sistema SOA Ticketing (8 Microservicios)
# ═══════════════════════════════════════════════════════════════════════════
#
# USO:
#   docker-compose up -d          # Iniciar todos los servicios en background
#   docker-compose logs -f        # Ver logs en tiempo real
#   docker-compose down           # Detener y eliminar contenedores
#   docker-compose ps             # Ver estado de servicios
#
# SERVICIOS:
#   - MySQL (3306): Base de datos
#   - Gateway (8080): API Gateway + JWT
#   - User Service (8081): Autenticación
#   - Event Service (8082): Gestión de eventos
#   - Camunda Service (8083): Coordinador SAGA
#   - Payment Service (8084): Procesamiento de pagos
#   - Notification Service (8085): Envío de emails
#   - Ticket Service (8086): Gestión de tickets
#   - Image Service (8087): Gestión de imágenes
#   - Frontend (80): Aplicación React SPA
# ═══════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────
  # Base de Datos MySQL 8.0
  # ─────────────────────────────────────────────────────────────────────────
  mysql:
    image: mysql:8.0
    container_name: soa-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      # Crear múltiples bases de datos al iniciar
      MYSQL_DATABASE: ticketing
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      # Script para crear las 3 bases de datos
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - soa-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─────────────────────────────────────────────────────────────────────────
  # User Service - Autenticación y gestión de usuarios (Puerto 8081)
  # ─────────────────────────────────────────────────────────────────────────
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: soa-user-service
    ports:
      - "8081:8081"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/ticketing
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      JWT_SECRET: mysecretkeymysecretkeymysecretkeymysecretkey
      GATEWAY_SECRET: soa-gateway-secret-key-2024
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - soa-network
    restart: on-failure

  # ─────────────────────────────────────────────────────────────────────────
  # Event Service - Gestión de eventos y tipos de entrada (Puerto 8082)
  # ─────────────────────────────────────────────────────────────────────────
  event-service:
    build:
      context: ./event-service
      dockerfile: Dockerfile
    container_name: soa-event-service
    ports:
      - "8082:8082"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/ticketing
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      GATEWAY_SECRET: soa-gateway-secret-key-2024
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - soa-network
    restart: on-failure

  # ─────────────────────────────────────────────────────────────────────────
  # Camunda Service - Coordinador SAGA (Puerto 8083)
  # ─────────────────────────────────────────────────────────────────────────
  camunda-service:
    build:
      context: ./camunda-service
      dockerfile: Dockerfile
    container_name: soa-camunda-service
    ports:
      - "8083:8083"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/orchestration_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      GATEWAY_SECRET: soa-gateway-secret-key-2024
      # URLs de servicios internos
      SERVICES_USER_SERVICE_URL: http://user-service:8081
      SERVICES_EVENT_SERVICE_URL: http://event-service:8082
      SERVICES_PAYMENT_SERVICE_URL: http://payment-service:8084
      SERVICES_NOTIFICATION_SERVICE_URL: http://notification-service:8085
      SERVICES_TICKET_SERVICE_URL: http://ticket-service:8086
    depends_on:
      mysql:
        condition: service_healthy
      user-service:
        condition: service_started
      event-service:
        condition: service_started
      payment-service:
        condition: service_started
      notification-service:
        condition: service_started
      ticket-service:
        condition: service_started
    networks:
      - soa-network
    restart: on-failure

  # ─────────────────────────────────────────────────────────────────────────
  # Payment Service - Mock de pasarela de pago (Puerto 8084)
  # ─────────────────────────────────────────────────────────────────────────
  payment-service:
    build:
      context: ./payment-service
      dockerfile: Dockerfile
    container_name: soa-payment-service
    ports:
      - "8084:8084"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/ticketing
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      GATEWAY_SECRET: soa-gateway-secret-key-2024
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - soa-network
    restart: on-failure

  # ─────────────────────────────────────────────────────────────────────────
  # Notification Service - Envío de emails (Puerto 8085)
  # ─────────────────────────────────────────────────────────────────────────
  notification-service:
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    container_name: soa-notification-service
    ports:
      - "8085:8085"
    environment:
      GATEWAY_SECRET: soa-gateway-secret-key-2024
      # Configuración Gmail SMTP (opcional - usa fallback a logs si no está configurado)
      SPRING_MAIL_USERNAME: ${GMAIL_USERNAME:-}
      SPRING_MAIL_PASSWORD: ${GMAIL_APP_PASSWORD:-}
    networks:
      - soa-network
    restart: on-failure

  # ─────────────────────────────────────────────────────────────────────────
  # Ticket Service - Gestión de tickets (Puerto 8086)
  # ─────────────────────────────────────────────────────────────────────────
  ticket-service:
    build:
      context: ./ticket-service
      dockerfile: Dockerfile
    container_name: soa-ticket-service
    ports:
      - "8086:8086"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/ticket_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      GATEWAY_SECRET: soa-gateway-secret-key-2024
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - soa-network
    restart: on-failure

  # ─────────────────────────────────────────────────────────────────────────
  # Image Service - Gestión de imágenes (Puerto 8087)
  # ─────────────────────────────────────────────────────────────────────────
  image-service:
    build:
      context: ./image-service
      dockerfile: Dockerfile
    container_name: soa-image-service
    ports:
      - "8087:8087"
    environment:
      GATEWAY_SECRET: soa-gateway-secret-key-2024
    volumes:
      - image_uploads:/app/uploads
    networks:
      - soa-network
    restart: on-failure

  # ─────────────────────────────────────────────────────────────────────────
  # Gateway - API Gateway con validación JWT (Puerto 8080)
  # ─────────────────────────────────────────────────────────────────────────
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: soa-gateway
    ports:
      - "8080:8080"
    environment:
      JWT_SECRET: mysecretkeymysecretkeymysecretkeymysecretkey
      GATEWAY_SECRET: soa-gateway-secret-key-2024
    depends_on:
      - user-service
      - event-service
      - camunda-service
      - payment-service
      - notification-service
      - ticket-service
      - image-service
    networks:
      - soa-network
    restart: on-failure

  # ─────────────────────────────────────────────────────────────────────────
  # Frontend - React SPA con Nginx (Puerto 80)
  # ─────────────────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
    container_name: soa-frontend
    ports:
      - "80:80"
    depends_on:
      - gateway
    networks:
      - soa-network
    restart: on-failure

# ═══════════════════════════════════════════════════════════════════════════
# Redes y Volúmenes
# ═══════════════════════════════════════════════════════════════════════════
networks:
  soa-network:
    driver: bridge

volumes:
  mysql_data:
  image_uploads:
