# ═══════════════════════════════════════════════════════════════════════════
# API GATEWAY - Spring Cloud Gateway Configuration
# ═══════════════════════════════════════════════════════════════════════════
#
# RESPONSABILIDADES:
# 1. Punto de entrada único para todos los clientes
# 2. Validación centralizada de JWT (JwtAuthenticationFilter)
# 3. Enrutamiento inteligente a 7 microservicios
# 4. Request Enrichment: Añade headers X-User-Email, X-User-ID, X-Gateway-Secret
# 5. CORS configuration para aplicaciones web
#
# FLUJO:
# Cliente → Gateway (valida JWT) → Servicio (confía en headers)
#
# SEGURIDAD:
# - Rutas públicas: /health, /register, /login
# - Rutas protegidas: Requieren JWT válido (filters: JwtAuthenticationFilter)
# - Header secreto: X-Gateway-Secret protege comunicación Gateway ↔ Servicios
#
# ═══════════════════════════════════════════════════════════════════════════

server:
  port: 8080

spring:
  application:
    name: gateway
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns:
              - "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600
            exposedHeaders:
              - Authorization
      
      routes:
        # User Service Routes
        - id: user-register
          uri: http://localhost:8081
          predicates:
            - Path=/api/users/register
            - Method=POST
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        - id: user-login
          uri: http://localhost:8081
          predicates:
            - Path=/api/users/login
            - Method=POST
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        - id: user-forgot-password
          uri: http://localhost:8081
          predicates:
            - Path=/api/users/forgot-password
            - Method=POST
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        - id: user-reset-password
          uri: http://localhost:8081
          predicates:
            - Path=/api/users/reset-password
            - Method=POST
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        - id: user-validate-reset-token
          uri: http://localhost:8081
          predicates:
            - Path=/api/users/validate-reset-token/{token}
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        - id: user-health
          uri: http://localhost:8081
          predicates:
            - Path=/api/users/health
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        - id: user-me
          uri: http://localhost:8081
          predicates:
            - Path=/api/users/me
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # User CRUD - Listar todos los usuarios (solo ADMIN)
        - id: user-list
          uri: http://localhost:8081
          predicates:
            - Path=/api/usuarios
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
            - name: RoleAuthorizationFilter
              args:
                roles: ADMIN
        
        # User CRUD - Obtener usuario por ID (requiere JWT)
        - id: user-get-by-id
          uri: http://localhost:8081
          predicates:
            - Path=/api/users/{id}
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # User CRUD - Actualizar usuario (requiere JWT)
        - id: user-update
          uri: http://localhost:8081
          predicates:
            - Path=/api/users/{id}
            - Method=PUT
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # User CRUD - Eliminar usuario (solo ADMIN)
        - id: user-delete
          uri: http://localhost:8081
          predicates:
            - Path=/api/users/{id}
            - Method=DELETE
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
            - name: RoleAuthorizationFilter
              args:
                roles: ADMIN
        
        # User Service Swagger
        - id: user-swagger-ui
          uri: http://localhost:8081
          predicates:
            - Path=/user-service/swagger-ui/**
          filters:
            - RewritePath=/user-service/swagger-ui/(?<segment>.*), /swagger-ui/$\{segment}
        
        - id: user-api-docs
          uri: http://localhost:8081
          predicates:
            - Path=/user-service/v3/api-docs/**
          filters:
            - RewritePath=/user-service/v3/api-docs/(?<segment>.*), /v3/api-docs/$\{segment}
        
        # Event Service Routes
        - id: event-health
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos/health
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Event CRUD - Crear evento (requiere JWT)
        - id: event-create
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos
            - Method=POST
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Event CRUD - Listar eventos
        - id: event-list
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Event CRUD - Listar eventos activos
        - id: event-list-activos
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos/activos
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Event CRUD - Listar eventos próximos
        - id: event-list-proximos
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos/proximos
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Event CRUD - Listar eventos con disponibilidad
        - id: event-list-disponibles
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos/disponibles
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Event CRUD - Obtener evento por ID
        - id: event-get-by-id
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos/{id}
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Event CRUD - Actualizar evento (requiere JWT)
        - id: event-update
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos/{id}
            - Method=PUT
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Event CRUD - Eliminar evento (requiere JWT)
        - id: event-delete
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos/{id}
            - Method=DELETE
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Event - Finalizar evento
        - id: event-finalize
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos/{id}/finalizar
            - Method=POST
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Tipos de Entrada Routes
        # Crear tipo de entrada para un evento (requiere JWT)
        - id: tipo-entrada-create
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos/{eventoId}/tipos-entrada
            - Method=POST
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Listar tipos de entrada de un evento
        - id: tipo-entrada-list-by-evento
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos/{eventoId}/tipos-entrada
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Actualizar tipo de entrada (requiere JWT)
        - id: tipo-entrada-update
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos/{eventoId}/tipos-entrada/{id}
            - Method=PUT
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Eliminar tipo de entrada (requiere JWT)
        - id: tipo-entrada-delete
          uri: http://localhost:8082
          predicates:
            - Path=/api/eventos/{eventoId}/tipos-entrada/{id}
            - Method=DELETE
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Obtener tipo de entrada por ID
        - id: tipo-entrada-get-by-id
          uri: http://localhost:8082
          predicates:
            - Path=/api/tipos-entrada/{id}
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Actualizar tipo de entrada (requiere JWT)
        - id: tipo-entrada-update
          uri: http://localhost:8082
          predicates:
            - Path=/api/tipos-entrada/{id}
            - Method=PUT
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Eliminar tipo de entrada (requiere JWT)
        - id: tipo-entrada-delete
          uri: http://localhost:8082
          predicates:
            - Path=/api/tipos-entrada/{id}
            - Method=DELETE
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Disminuir cantidad de tipo de entrada (uso interno - requiere JWT)
        - id: tipo-entrada-decrease
          uri: http://localhost:8082
          predicates:
            - Path=/api/tipos-entrada/{id}/disminuir
            - Method=PUT
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Event Service Swagger
        - id: event-swagger-ui
          uri: http://localhost:8082
          predicates:
            - Path=/event-service/swagger-ui/**
          filters:
            - RewritePath=/event-service/swagger-ui/(?<segment>.*), /swagger-ui/$\{segment}
        
        - id: event-api-docs
          uri: http://localhost:8082
          predicates:
            - Path=/event-service/v3/api-docs/**
          filters:
            - RewritePath=/event-service/v3/api-docs/(?<segment>.*), /v3/api-docs/$\{segment}
        
        # Payment Service Routes
        - id: payment-health
          uri: http://localhost:8084
          predicates:
            - Path=/api/payments/health
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Image Service Routes
        - id: image-upload
          uri: http://localhost:8087
          predicates:
            - Path=/api/images/upload
            - Method=POST
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        - id: image-delete
          uri: http://localhost:8087
          predicates:
            - Path=/api/images/{fileName}
            - Method=DELETE
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        - id: image-serve
          uri: http://localhost:8087
          predicates:
            - Path=/uploads/**
            - Method=GET
        
        - id: image-health
          uri: http://localhost:8087
          predicates:
            - Path=/api/images/health
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Notification Service Routes
        - id: notification-health
          uri: http://localhost:8085
          predicates:
            - Path=/api/notifications/health
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Orchestration Service Routes
        - id: orchestration-health
          uri: http://localhost:8083
          predicates:
            - Path=/api/orchestration/health
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Registro de usuario con notificación (público, NO requiere JWT)
        - id: orchestration-register
          uri: http://localhost:8083
          predicates:
            - Path=/api/orchestration/register
            - Method=POST
          filters:
            - RewritePath=/api/orchestration/register, /api/camunda/register
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Crear evento con notificación (requiere JWT)
        - id: orchestration-create-event
          uri: http://localhost:8083
          predicates:
            - Path=/api/orchestration/create-event
            - Method=POST
          filters:
            - RewritePath=/api/orchestration/create-event, /api/camunda/create-event
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Comprar ticket (requiere JWT)
        - id: orchestration-purchase-ticket
          uri: http://localhost:8083
          predicates:
            - Path=/api/orchestration/purchase-ticket
            - Method=POST
          filters:
            - RewritePath=/api/orchestration/purchase-ticket, /api/camunda/purchase-ticket
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Obtener mis tickets (requiere JWT)
        - id: orchestration-my-tickets
          uri: http://localhost:8083
          predicates:
            - Path=/api/orchestration/my-tickets
            - Method=GET
          filters:
            - RewritePath=/api/orchestration/my-tickets, /api/camunda/my-tickets
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Camunda Service Routes (BPMN Workflows)
        - id: camunda-health
          uri: http://localhost:8083
          predicates:
            - Path=/api/camunda/health
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Comprar ticket via Camunda workflow (requiere JWT + headers X-User-ID y X-User-Email)
        - id: camunda-purchase-ticket
          uri: http://localhost:8083
          predicates:
            - Path=/api/camunda/purchase-ticket
            - Method=POST
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Verificar estado de proceso Camunda (requiere JWT)
        - id: camunda-process-status
          uri: http://localhost:8083
          predicates:
            - Path=/api/camunda/process-status/**
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Ticket Service Routes (uso principalmente interno)
        - id: ticket-health
          uri: http://localhost:8086
          predicates:
            - Path=/api/tickets/health
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
        
        # Listar todos los tickets (solo ADMIN)
        - id: ticket-list
          uri: http://localhost:8086
          predicates:
            - Path=/api/tickets
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
            - name: RoleAuthorizationFilter
              args:
                roles: ADMIN
        
        # Obtener ticket por ID (requiere JWT - TODO: validar ownership o ADMIN)
        - id: ticket-get-by-id
          uri: http://localhost:8086
          predicates:
            - Path=/api/tickets/{ticketId}
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Obtener tickets por usuario (requiere JWT - TODO: validar self-access o ADMIN)
        - id: ticket-list-by-user
          uri: http://localhost:8086
          predicates:
            - Path=/api/tickets/user/{usuarioId}
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Reserva Routes
        # Crear reserva (requiere JWT)
        - id: reserva-create
          uri: http://localhost:8086
          predicates:
            - Path=/api/reservas/crear
            - Method=POST
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Confirmar reserva (requiere JWT)
        - id: reserva-confirm
          uri: http://localhost:8086
          predicates:
            - Path=/api/reservas/{id}/confirmar
            - Method=PUT
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Liberar reserva (requiere JWT)
        - id: reserva-release
          uri: http://localhost:8086
          predicates:
            - Path=/api/reservas/{id}/liberar
            - Method=PUT
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter
        
        # Obtener reservas activas por usuario (requiere JWT)
        - id: reserva-list-by-user
          uri: http://localhost:8086
          predicates:
            - Path=/api/reservas/usuario/{usuarioId}/activas
            - Method=GET
          filters:
            - AddRequestHeader=X-Gateway-Secret, ${gateway.secret}
            - name: JwtAuthenticationFilter

# JWT Configuration
jwt:
  secret: c29hLXRpY2tldGluZy1zZWNyZXQta2V5LW1pbmltdW0tMjU2LWJpdHMtZm9yLWhtYWMyNTYtYWxnb3JpdGhtLXBsZWFzZS1jaGFuZ2UtaW4tcHJvZHVjdGlvbg==
  expiration: 86400000

# Gateway Secret (para validar que las peticiones vienen del Gateway)
gateway:
  secret: soa-gateway-secret-key-2024

# Logging
logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    reactor.netty: DEBUG
